<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>KISDigital - Building a CF sitemap generator</title>
	<meta name="description" content="ColdFusion, ColdBox, CommandBox and other assorted musings">
	<meta name="author" content="Robert Zehnder">
	<meta name="twitter:widgets:theme" content="light">
	<meta name="twitter:widgets:border-color" content="#55acee">
			<meta property="og:title" content="Building a CF sitemap generator" />
			<meta property="og:description" content="A simple script to crawl a site and build a sitemap.xml" />
			<meta property="og:image" content="https://static.kisdigital.com/images/2022/06/spiderweb.jpeg" />
			<meta name="twitter:card" content="summary_large_image" />
			<meta name="twitter:title" content="Building a CF sitemap generator" />
			<meta name="twitter:description" content="A simple script to crawl a site and build a sitemap.xml" />
			<meta name="twitter:image" content="https://static.kisdigital.com/images/2022/06/spiderweb.jpeg" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-one-dark.min.css" integrity="sha512-c6S8OdtvoqZCbMfA1lWE0qd368pLdFvVHVILQzNizfowC+zV8rmVKdSlmL5SuidvATO0A7awDg53axd+s/9amw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="/assets/css/site.css?v=1703108634386">
</head>
<body style="padding-top: 70px;">
	<header>
		<nav class="header">
			<div class="container">
				<div class="row">
					<div class="col-2">
						<a class="site-link" href="/"><span style="color: var(--post-link-text)">KIS</span>Digital</a>
					</div>
					<div class="col-10"></div>
				</div>
			</div>
		</nav>
	</header>
	<div class="container text-white">
<div class="row">
	<div class="col-lg-8 col-md-12">
		<div class="card rf-card-bordered">
			<div class="card-body">
				<div style="background: url(https://static.kisdigital.com/images/2022/06/spiderweb.jpeg) no-repeat center center; background-size: cover; height: 350px;">
					<div class="bg-dark w-75 opacity-75 p-2">
						<p class="h2 text-white">Building a CF sitemap generator</p>
						<small class="d-block text-white py-1">A simple script to crawl a site and build a sitemap.xml</small>
							<span class="badge bg-light m-1 p-2 h5 text-dark">cfml</span>
						<p class="text-white small text-uppercase">
							June 12, 2022 /
							Robert Zehnder
						</p>
					</div>
				</div>
				<div class="my-3">
					<a href="https://www.facebook.com/sharer/sharer.php?u=https://kisdigital.com/posts/2022/building-a-cf-sitemap-generator" class="text-decoration-none" target="_blank">
						<i class="bi bi-facebook px-1 text-white fs-5"></i>
					</a>
					<a href="https://www.twitter.com/share?url=https://kisdigital.com/posts/2022/building-a-cf-sitemap-generator" class="text-decoration-none" target="_blank">
						<i class="bi bi-twitter px-1 text-white fs-5"></i>
					</a>
					<a href="https://www.linkedin.com/sharing/share-offsite/?url=https://kisdigital.com/posts/2022/building-a-cf-sitemap-generator" class="text-decoration-none" target="_blank">
						<i class="bi bi-linkedin px-1 text-white fs-5"></i>
					</a>
				</div>
				<div class="my-3 text-white decorate-links post">
					<p>The other day I found the need to create a sitemap for a rather large domain at work. The site in question has a few static pages, but there are a lot of dynamic pages that would be hard to go through every possible page combination. In order to speed things up a bit I thought I would write a quick webcrawler to go through the site and help me build the list of site links.</p>
<p>It does take a little effort to get things up and running because the a database is required for tracking all the links. Also I use a scheduled task that gets called to crawl the next batch of links and add any new links to the queue. My datasource is called <code>ufapp</code> but the datasource can be whatever you like. Here is the table structure required.</p>
<pre><code class="language-sql">-- ufapp.sitemap definition
CREATE TABLE `sitemap` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `url` varchar(1000) NOT NULL UNIQUE,
 `crawled` bit(1) NOT NULL DEFAULT b'0',
 `statuscode` varchar(100) NOT NULL DEFAULT '200',
 PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
</code></pre>
<h3>The Crawler</h3>
<p>The crawler iself is a simple <code>cfhttp</code> call that pipes the fileContent returned through jSoup parse the HTML for anchor links. If you are not familiar with jSoup it is simply a Java HTML parser that will allow you to extract and manipulate data. The <code>cfhttp</code> has <code>resolveURL=true</code> and <code>redirect=false</code> set. This ensures relative links do not cause an issue and do not follow redirects.</p>
<p>A new instance of the JavaLoaderFactory will be created and stored in the application scope if it does not already exist. All worker pages will use JavaLoader to create the jSoup object used to parse the HTML.</p>
<p>The first step is to kick off the process by calling spider.cfm with the domain you would like to crawl. As an example, <code>spider.cfm?domain=kisdigital.com</code> would look for all links on my domain.</p>
<pre><code class="language-javascript">&lt;cfscript&gt;
 // spider.cfm
 javaloader = application.javaLoaderFactory.getJavaLoader([expandPath('/lib/jsoup-1.12.1.jar')]);
 jsoup = javaloader.create('org.jsoup.Jsoup');
 // use the domain if it is passed in
 domain = url.keyExists(&quot;domain&quot;) ? url.domain : &quot;&quot;;
 allLinks = [];
 function getLinks(required string page){
  cfhttp(url = page, resolveURL = true, redirect = false);
  jsDoc = jsoup.parse(cfhttp.fileContent);
  els = jsDoc.select(&quot;a[href]&quot;);
  out = [];
  els.each((item) =&gt; {
   if(
    item.attr( &quot;href&quot; ).len() &amp;&amp;
    item.attr( &quot;href&quot; ).findNoCase( 'https://' &amp; domain ) == 1
   ){
    out.append( item.attr(&quot;href&quot;) );
   }
  });
  return out;
 }
 allLinks.append(getLinks(page = &quot;https://&quot; &amp; domain), true);
 allLinks.each((lnk) =&gt; {
  try{
   queryExecute(&quot;INSERT INTO sitemap (url) VALUES (:link)&quot;, {
    'link': { value: lnk, cfsqltype: &quot;cf_sql_varchar&quot; }
   }, { datasource: &quot;ufapp&quot; });
  }
  catch(any e){} // insert failed (dupe)
 })
&lt;/cfscript&gt;
</code></pre>
<p>Once the initial page is loaded everything the scheduled task takes over. Every 60 seconds <code>task.cfm</code> is called which crawls the next chunk URLs in the database and stores the status code. Currently it is configured to ignore any URL that is not present on the current domain.</p>
<pre><code class="language-javascript">&lt;cfscript&gt;
 // task.cfm
 javaloader = application.javaLoaderFactory.getJavaLoader([expandPath('/lib/jsoup-1.12.1.jar')]);
 jsoup = javaloader.create('org.jsoup.Jsoup');
 checklist = queryExecute(&quot;
  SELECT id, url, (SELECT SUBSTRING_INDEX(REPLACE(REPLACE(url, 'http://', ''), 'https://', ''), '/', 1)) AS domain
  FROM sitemap s
  WHERE s.crawled = 0
  ORDER BY s.id
  LIMIT 60
 &quot;, [], { datasource: 'ufapp' });
 checklist.each((row) =&gt; {
  cfhttp(url = row.url, resolveURL = true, redirect = false);
  queryExecute(&quot;UPDATE sitemap SET statuscode = :statuscode, crawled = 1 WHERE id = :id&quot;, {
   'statuscode': { value: cfhttp.statuscode, cfsqltype: &quot;cf_sql_varchar&quot; },
   'id': { value: row.id, cfsqltype: &quot;cf_sql_numeric&quot; }
  }, { datasource: &quot;ufapp&quot; });
  jsDoc = jsoup.parse(cfhttp.fileContent);
  els = jsDoc.select(&quot;a[href]&quot;);
  out = [];
  els.each((item) =&gt; {
   if(
    item.attr( &quot;href&quot; ).len() &amp;&amp;
    item.attr( &quot;href&quot; ).findNoCase( 'https://' &amp; row.domain ) == 1
   ){
    out.append( item.attr( &quot;href&quot; ) );
   }
  });
  for(var o in out){
   try{
    queryExecute(&quot;INSERT INTO sitemap (url) VALUES (:link)&quot;, {
     'link': { value: o, cfsqltype: &quot;cf_sql_varchar&quot; }
    }, { datasource: &quot;ufapp&quot; });
   }
   catch(any e){} // insert failed (duplicate)
  }
 })
&lt;/cfscript&gt;
</code></pre>
<h3>Generating the Sitemap</h3>
<p>Generating the sitemap is the easiest part of the process. To do so, call sitemap.cfm with the domain passed as a URL parameter, like so: <code>sitemap.cfm?domain=kisdigital.com</code>. This will output <code>sitemap.xml</code> for the domain in the current directory.</p>
<pre><code class="language-javascript">&lt;cfsetting enablecfoutputonly=&quot;true&quot; /&gt;
&lt;cfscript&gt;
 // sitemap.cfm
 domain = url.keyExists(&quot;domain&quot;) ? url.domain : &quot;&quot;;
 locs = queryExecute(&quot;
  SELECT DISTINCT s.url
  FROM sitemap s
  WHERE s.url LIKE :domain AND s.statuscode = '200 OK'
  ORDER by s.url&quot;, {
   'domain': { value: &quot;%&quot; &amp; domain &amp; &quot;/%&quot;, cfsqltype: &quot;cf_sql_varchar&quot; }
  }, { datasource: &quot;ufapp&quot; });
 lastmod = dateFormat(now(), &quot;yyyy-mm-dd&quot;);
 out = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;urlset xmlns=&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;&gt; ';
savecontent variable = &quot;xmlBody&quot; {
for(u in locs){writeOutput('
&lt;url&gt;
 &lt;loc&gt;#u.url#&lt;/loc&gt;
 &lt;lastmod&gt;#lastmod#&lt;/lastmod&gt;
&lt;/url&gt;');}
};
 out &amp;= xmlBody;
 out &amp;= &quot;&lt;/urlset&gt;&quot;;
 fileWrite(expandPath(&quot;.&quot;) &amp; &quot;/sitemap-&quot; &amp; domain.replace(&quot;.&quot;, &quot;_&quot;, &quot;all&quot;) &amp; &quot;.xml&quot;, out);
&lt;/cfscript&gt;
</code></pre>
<p>Here is a link to the code: <a href="https://github.com/robertz/cfspider">https://github.com/robertz/cfspider</a></p>
				</div>
<div id="disqus_thread"></div>
<script>
	/**
	 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
	var disqus_config = function () {
		this.page.url = "https://kisdigital.com/posts/2022/building-a-cf-sitemap-generator";
		this.page.identifier = "/posts/2022/building-a-cf-sitemap-generator"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};
	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = 'https://kisdigital.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			</div>
		</div>
	</div>
	<div class="col-lg-4 d-none d-lg-block d-xl-block">
<div>
	<div class="card rf-card-bordered text-white">
		<div class="card-body">
			<div class="card-title">
				<span class="h6">KISDigital</span>
			</div>
			<div class="card-text">
				<small>
					ColdFusion, ColdBox, CommandBox and assorted musings.
				</small>
			</div>
		</div>
	</div>
	<div class="card rf-card-bordered text-white mt-3">
		<div class="card-body">
			<div class="card-title">
				<span class="h6">Tags</span>
			</div>
			<div class="card-text">
					<a href="/tag/misc"> <span class="h5"><span class="badge bg-info text-muted p-2">misc</span></span></a>
					<a href="/tag/cfml"> <span class="h5"><span class="badge bg-info text-muted p-2">cfml</span></span></a>
					<a href="/tag/commandbox"> <span class="h5"><span class="badge bg-info text-muted p-2">commandbox</span></span></a>
					<a href="/tag/sql"> <span class="h5"><span class="badge bg-info text-muted p-2">sql</span></span></a>
			</div>
		</div>
	</div>
	<div class="card rf-card-bordered text-white mt-3">
		<div class="card-body">
			<div class="card-title">
				<span class="h6">Recent Posts</span>
			</div>
			<div class="card-text">
					<a href="/posts/2023/merry-christmas-and-happy-new-year" class="post-link text-decoration-none">Wishing you a Merry Christmas</a><br />
					<a href="/posts/2023/commandbox-ssg-updates" class="post-link text-decoration-none">Commandbox-ssg updates</a><br />
					<a href="/posts/2023/an-introduction-to-commandbox-ssg" class="post-link text-decoration-none">An introduction to commandbox-ssg</a><br />
					<a href="/posts/2023/bringing-back-commandbox-ssg" class="post-link text-decoration-none">Bringing back commandbox-ssg</a><br />
					<a href="/posts/2023/introducing-commandbox-apiman" class="post-link text-decoration-none">Introducing commandbox-apiman</a><br />
			</div>
		</div>
	</div>
</div>
	</div>
</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/gh/dkern/jquery.lazy@1.7.10/jquery.lazy.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/gh/dkern/jquery.lazy@1.7.10/jquery.lazy.plugins.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js" integrity="sha512-YBk7HhgDZvBxmtOfUdvX0z8IH2d10Hp3aEygaMNhtF8fSOvBZ16D/1bXZTJV6ndk/L/DlXxYStP8jrF77v2MIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="/assets/js/global.js?v=1703108634386"></script>
	<script>
		$(function($) {
			$('.lazy img').lazy()
		})
	</script>
</body>
</html>